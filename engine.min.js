import{baseQuestions as e}from"./data.js";import{backendClient as t}from"./backendClient.js";const n=["Cardiovascular Disorders","Infectious Diseases","Endocrinology","Respiratory Disorders","Renal & Electrolyte Disorders","Gastrointestinal Disorders","Neurology & Psychiatry","Hematology","Oncology","Rheumatology & Pain","Women's & Men's Health","Immunizations","Pharmacy Law & Ethics"],i={Cardiology:"Cardiovascular Disorders","Clinical Pharmacology":"Pharmacy Law & Ethics",Haematology:"Hematology",Hematology:"Hematology",Endocrinology:"Endocrinology",Oncology:"Oncology",Neurology:"Neurology & Psychiatry",Psychiatry:"Neurology & Psychiatry",Respiratory:"Respiratory Disorders",Gastroenterology:"Gastrointestinal Disorders",Rheumatology:"Rheumatology & Pain",Dermatology:"Rheumatology & Pain",Obstetrics:"Women's & Men's Health","Allergy and Immunology":"Respiratory Disorders","Infectious Diseases":"Infectious Diseases"};function r(e,t=""){const n=String(e||"").trim();if(i[n])return i[n];const r=`${n} ${String(t||"")}`.toLowerCase();return r.includes("cardio")||r.includes("hypertens")?"Cardiovascular Disorders":r.includes("infect")||r.includes("antibiotic")?"Infectious Diseases":r.includes("diabet")||r.includes("thyroid")?"Endocrinology":r.includes("respir")||r.includes("asthma")||r.includes("allergic rhinitis")?"Respiratory Disorders":r.includes("renal")||r.includes("kidney")?"Renal & Electrolyte Disorders":r.includes("gastro")||r.includes("hepat")?"Gastrointestinal Disorders":r.includes("neuro")||r.includes("psy")||r.includes("seizure")?"Neurology & Psychiatry":r.includes("haemat")||r.includes("hemat")||r.includes("anemia")?"Hematology":r.includes("onco")||r.includes("cancer")?"Oncology":r.includes("rheuma")||r.includes("arthritis")||r.includes("gout")||r.includes("pain")||r.includes("dermat")?"Rheumatology & Pain":r.includes("pregnan")||r.includes("contraception")||r.includes("bph")?"Women's & Men's Health":r.includes("vaccine")||r.includes("immunization")?"Immunizations":(r.includes("law")||r.includes("ethic"),"Pharmacy Law & Ethics")}let s,o,a=0,c=0,d="",l=[],u=0,m={},g="",y=0,f=!1,h=!1,p=!1,v=0,E=!1,I=!1,b=JSON.parse(localStorage.getItem("weakTracker"))||{};function w(){localStorage.setItem("weakTracker",JSON.stringify(b))}let L=parseInt(localStorage.getItem("quizBestStreak"))||0,x=JSON.parse(localStorage.getItem("quizSessionHistory"))||[],B=e.map(function(e){const t=String(e?.question||e?.text||""),n=String(e?.explanation||"");return{...e,category:r(e?.category,`${t} ${n}`)}});const S={};let k=!1,T=null,q=null,C="login",A={topics:[],categories:[]},z=!1,N="quiz-menu",M="topic-library";function $(){Object.keys(S).forEach(e=>delete S[e]),B.forEach(e=>{e.caseId&&e.caseBlock&&(S[e.caseId]=e.caseBlock)})}function P(e){return B.find(t=>Number(t.id)===Number(e))}$();let H=JSON.parse(localStorage.getItem("quizPerformance"))||{};function D(e,n){H[e]||(H[e]={attempts:0,correct:0}),H[e].attempts++,n&&H[e].correct++;const i=P(e);i&&i.category&&function(e,t){R[e]||(R[e]={attempts:0,correct:0});R[e].attempts++,t&&R[e].correct++;localStorage.setItem("quizCategoryPerformance",JSON.stringify(R))}(i.category,n),t.syncPerformance({questionId:e,isCorrect:n,category:i?.category||"General"}),localStorage.setItem("quizPerformance",JSON.stringify(H))}function O(e){const t=H[e];return t&&0!==t.attempts?Math.round(t.correct/t.attempts*100):100}let R=JSON.parse(localStorage.getItem("quizCategoryPerformance"))||{};function W(e){const t=R[e];return t&&0!==t.attempts?Math.round(t.correct/t.attempts*100):100}const j=document.querySelector(".study-mode"),F=document.querySelector(".exam-mode"),J=document.querySelector(".dashboard-mode"),U=document.getElementById("open-topic-library-btn"),Q=document.querySelector(".history-mode");Q&&(Q.onclick=()=>{});const G=document.getElementById("question"),K=document.getElementById("answers"),Y=document.getElementById("next-btn"),_=document.getElementById("prev-btn"),V=document.getElementById("timer"),X=document.getElementById("explanation"),Z=document.getElementById("question-topic-link-wrap"),ee=document.getElementById("topic-link-btn"),te=document.getElementById("quiz-area"),ne=document.getElementById("progress"),ie=document.getElementById("live-score"),re=document.getElementById("back-review-btn"),se=(document.getElementById("quiz-menu"),document.getElementById("home-screen"),document.getElementById("back-home-btn")),oe=document.getElementById("back-btn-quiz"),ae=document.getElementById("menu-btn-quiz"),ce=document.getElementById("combo-block"),de=document.getElementById("exam-exit-modal"),le=document.getElementById("cancel-exit-btn"),ue=document.getElementById("confirm-exit-btn"),me=document.getElementById("auth-modal"),ge=document.getElementById("auth-form"),ye=document.getElementById("auth-tab-login"),fe=document.getElementById("auth-tab-register"),he=document.getElementById("auth-identifier-wrap"),pe=document.getElementById("auth-identifier"),ve=document.getElementById("auth-title-wrap"),Ee=document.getElementById("auth-title"),Ie=document.getElementById("auth-first-name-wrap"),be=document.getElementById("auth-first-name"),we=document.getElementById("auth-last-name-wrap"),Le=document.getElementById("auth-last-name"),xe=document.getElementById("auth-username-wrap"),Be=document.getElementById("auth-username"),Se=document.getElementById("auth-contact-wrap"),ke=document.getElementById("auth-contact"),Te=document.getElementById("auth-role-wrap"),qe=document.getElementById("auth-prof-type-wrap"),Ce=document.getElementById("auth-professional-type"),Ae=document.getElementById("auth-country-wrap"),ze=document.getElementById("auth-country"),Ne=document.getElementById("auth-institution-wrap"),Me=document.getElementById("auth-institution"),$e=document.getElementById("auth-reset-code-wrap"),Pe=document.getElementById("auth-reset-code"),He=document.getElementById("auth-password-wrap"),De=document.getElementById("auth-password"),Oe=document.getElementById("auth-password-toggle"),Re=document.getElementById("auth-forgot-link"),We=document.getElementById("auth-reset-link"),je=document.getElementById("auth-back-login-link"),Fe=document.getElementById("auth-reset-code-preview"),Je=document.getElementById("auth-error"),Ue=document.getElementById("auth-submit-btn"),Qe=document.getElementById("auth-cancel-btn"),Ge=document.getElementById("quiz-auth-user"),Ke=document.getElementById("quiz-profile-btn"),Ye=Ke?.querySelector(".menu-profile-icon"),_e=document.getElementById("quiz-logout-btn"),Ve=document.getElementById("profile-back-btn"),Xe=document.getElementById("profile-save-btn"),Ze=document.getElementById("profile-change-password-btn"),et=document.getElementById("profile-deactivate-btn"),tt=document.getElementById("profile-delete-btn"),nt=document.getElementById("profile-feedback"),it=document.getElementById("profile-avatar-preview"),rt=document.getElementById("profile-photo-file"),st=document.getElementById("profile-photo-url"),ot=document.getElementById("profile-title"),at=document.getElementById("profile-first-name"),ct=document.getElementById("profile-last-name"),dt=document.getElementById("profile-username"),lt=document.getElementById("profile-contact"),ut=document.getElementById("profile-professional-type"),mt=document.getElementById("profile-country"),gt=document.getElementById("profile-institution"),yt=document.getElementById("profile-current-password"),ft=document.getElementById("profile-new-password"),ht=document.getElementById("profile-deactivate-days"),pt=document.getElementById("study-history-toggle"),vt=document.getElementById("study-history"),Et=document.getElementById("topic-library-category"),It=document.getElementById("topic-library-search"),bt=document.getElementById("topic-library-list"),wt=document.getElementById("topic-library-count"),Lt=document.getElementById("topic-library-empty"),xt=document.getElementById("topic-library-back-btn"),Bt=document.getElementById("topic-viewer-back-btn"),St=document.getElementById("topic-viewer-menu-btn"),kt=document.getElementById("topic-viewer-title"),Tt=document.getElementById("topic-viewer-frame");pt&&vt&&pt.addEventListener("click",()=>{vt.classList.toggle("hidden"),pt.classList.toggle("open")});const qt=document.getElementById("exam-history-toggle"),Ct=document.getElementById("exam-history");function At(e){if(!De||!Oe)return;const t=Boolean(e);De.type=t?"text":"password",Oe.setAttribute("aria-label",t?"Hide password":"Show password"),Oe.setAttribute("aria-pressed",t?"true":"false");const n=Oe.querySelector(".icon-eye"),i=Oe.querySelector(".icon-eye-off");n&&n.classList.toggle("hidden",t),i&&i.classList.toggle("hidden",!t)}function zt(e){const t=String(e||"").trim().toLowerCase().replace(/_/g,"-").replace(/\s+/g,"-");return/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(t)?t:""}function Nt(e){if(!Z||!ee)return;if(!("study"===d))return Z.classList.add("hidden"),void ee.removeAttribute("href");const t=function(e){const t=zt(e?.topicSlug);if(!t)return"";const n=zt(e?.sectionId);return`topics/${t}.html${n?`#${n}`:""}`}(e);if(!t)return Z.classList.add("hidden"),void ee.removeAttribute("href");ee.href=t,Z.classList.remove("hidden")}function Mt(e){return String(e||"").split("-").filter(Boolean).map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}function $t(e){const t=String(e||"").trim().toLowerCase();return t&&/^[a-z0-9-]+\.html(?:#[a-z0-9-]+)?$/.test(t)?`topics/${t}`:""}function Pt(e){return String(e?.title||"").trim()||Mt(e?.slug)||"Study Note"}function Ht(){const e=Array.isArray(A?.topics)?A.topics:[],t=String(Et?.value||"all"),n=String(It?.value||"").trim().toLowerCase();return e.filter(e=>("all"===t||e.category===t)&&(!n||function(e){const t=Array.isArray(e?.sections)?e.sections.map(e=>e.title||""):[];return[e?.title,e?.slug,e?.summary,e?.category,...Array.isArray(e?.tags)?e.tags:[],...t].join(" ").toLowerCase()}(e).includes(n))).sort((e,t)=>Pt(e).localeCompare(Pt(t)))}function Dt(){if(!bt||!Lt||!wt)return;const e=Ht();bt.innerHTML="",e.forEach(e=>{const t=$t(e.notePath)||$t(`${String(e.slug||"").toLowerCase()}.html`);if(!t)return;const n=document.createElement("button");n.type="button",n.className="topic-library-item",n.innerHTML=`\n      <span class="topic-library-item-title">${Pt(e)}</span>\n      <span class="topic-library-item-meta">${e.category||"General"}</span>\n    `,n.addEventListener("click",()=>{Ot(t,Pt(e),"topic-library")}),bt.appendChild(n)}),wt.textContent=`${e.length} topic(s)`,Lt.classList.toggle("hidden",e.length>0)}function Ot(e,t="Study Note",n="topic-library"){Tt&&(M=n,Tt.src=e,kt&&(kt.innerText=`Study Note: ${t}`),$n("topic-viewer"))}function Rt(e=""){if(!Je)return;const t=String(e||"").trim();Je.textContent=t,Je.classList.toggle("hidden",!t)}function Wt(e="",t=!1){if(!Fe)return;const n=String(e||"").trim();Fe.textContent=n,Fe.classList.toggle("hidden",!n),Fe.classList.remove("auth-error","auth-info"),n&&Fe.classList.add(t?"auth-error":"auth-info")}function jt(e,t=""){const n=document.querySelector(`input[name="${e}"]:checked`);return n?String(n.value||"").trim():t}qt&&Ct&&qt.addEventListener("click",()=>{Ct.classList.toggle("hidden"),qt.classList.toggle("open")}),Et&&Et.addEventListener("change",Dt),It&&It.addEventListener("input",Dt),U&&U.addEventListener("click",()=>{!function(e="quiz-menu"){N=e,$n("topic-library"),async function(){if(z)return;try{const e=await fetch("topics/topics.json",{cache:"no-store"});if(!e.ok)throw new Error(`topics.json failed (${e.status})`);A=await e.json()}catch(e){console.warn("Topic catalog fallback enabled:",e),A={topics:[{slug:"heart-failure",title:"Heart Failure",category:"Cardiovascular Disorders",summary:"HFrEF/HFpEF classification, four-pillar HFrEF therapy, and acute decompensation.",notePath:"heart-failure.html"},{slug:"hypertension",title:"Hypertension",category:"Cardiovascular Disorders",summary:"Blood pressure classification, first-line treatment, and hypertensive crisis.",notePath:"hypertension.html"}],categories:[...n]}}finally{z=!0,Dt()}}(),Dt()}("quiz-menu")}),xt&&xt.addEventListener("click",()=>{$n(N||"quiz-menu")}),Bt&&Bt.addEventListener("click",()=>{$n(M||"topic-library")}),St&&St.addEventListener("click",()=>{$n("quiz-menu")});let Ft="";function Jt(e=""){if(!it)return;const t=String(e||"").trim();it.src=t||function(){const e=String(q?.username||q?.firstName||q?.name||"U").trim().slice(0,2).toUpperCase();return`data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='120' height='120' rx='18' fill='#0f3f7f'/><text x='60' y='72' text-anchor='middle' font-size='42' font-family='Arial' fill='#fff'>${e||"U"}</text></svg>`)}`}()}function Ut(e=""){if(!Ke)return;const t=String(e||"").trim();if(t)return Ke.style.backgroundImage=`url("${t}")`,Ke.style.backgroundSize="cover",Ke.style.backgroundPosition="center",Ke.style.backgroundRepeat="no-repeat",Ke.classList.add("has-avatar"),void(Ye&&Ye.classList.add("hidden"));Ke.style.backgroundImage="",Ke.style.backgroundSize="",Ke.style.backgroundPosition="",Ke.style.backgroundRepeat="",Ke.classList.remove("has-avatar"),Ye&&Ye.classList.remove("hidden")}function Qt(e="",t=!1){if(!nt)return;const n=String(e||"").trim();nt.textContent=n,nt.classList.toggle("hidden",!n),nt.classList.remove("auth-error","auth-info"),n&&nt.classList.add(t?"auth-error":"auth-info")}function Gt(){q&&(ot&&(ot.value=q.title||""),at&&(at.value=q.firstName||""),ct&&(ct.value=q.lastName||""),dt&&(dt.value=q.username||""),lt&&(lt.value=q.contact||""),ut&&(ut.value=q.professionalType||"Other"),mt&&(mt.value=q.country||""),gt&&(gt.value=q.institution||""),function(e,t){const n=String(t||"").trim();document.querySelectorAll(`input[name="${e}"]`).forEach(e=>{e.checked=String(e.value)===n})}("profile-role",q.role||"student"),Ft=String(q.profileImage||"").trim(),st&&(st.value=Ft),Jt(Ft),Ut(Ft))}function Kt(){if(Ge&&_e&&Ke){if(q){const e=String(q.username||"").trim(),t=q.name||q.contact||"User";return Ge.textContent=e?`@${e}`:t,Ge.classList.remove("hidden"),_e.classList.remove("hidden"),Ke.classList.remove("hidden"),Ut(q.profileImage||""),void Gt()}Ge.textContent="",Ge.classList.add("hidden"),_e.classList.add("hidden"),Ke.classList.add("hidden"),Ut("")}}function Yt(e="login"){const t=new Set(["login","register","forgot","reset"]);C=t.has(e)?e:"login";const n="login"===C,i="register"===C,r="forgot"===C,s="reset"===C;ye&&ye.classList.toggle("active",n),fe&&fe.classList.toggle("active",i),he&&he.classList.toggle("hidden",i),ve&&ve.classList.toggle("hidden",!i),Ie&&Ie.classList.toggle("hidden",!i),we&&we.classList.toggle("hidden",!i),xe&&xe.classList.toggle("hidden",!i),Se&&Se.classList.toggle("hidden",!i),Te&&Te.classList.toggle("hidden",!i),qe&&qe.classList.toggle("hidden",!i),Ae&&Ae.classList.toggle("hidden",!i),Ne&&Ne.classList.toggle("hidden",!i),$e&&$e.classList.toggle("hidden",!s),He&&He.classList.toggle("hidden",r),Re&&Re.classList.toggle("hidden",!n),We&&We.classList.toggle("hidden",!n),je&&je.classList.toggle("hidden",n),De&&De.setAttribute("autocomplete",n?"current-password":"new-password"),Ue&&(i&&(Ue.textContent="Create Account"),n&&(Ue.textContent="Sign In"),r&&(Ue.textContent="Send Reset Code"),s&&(Ue.textContent="Reset Password")),At(!1),Rt(""),Wt("")}function _t(){me&&(me.classList.add("hidden"),At(!1),Wt(""),document.body.style.overflow="")}function Vt(e){const t=String(e?.message||"");return t.includes("invalid credentials")||t.includes("(401)")?"Invalid username/contact/email or password.":t.includes("deactivated")||t.includes("(403)")||t.includes("(409)")||t.includes("(400)")?t.replace(/\s+\(\d+\)\s*$/,""):"Unable to sign in right now. Please try again."}async function Xt(){if(!t.isAuthenticated())return q=null,Kt(),!1;try{return q=await t.fetchMe(),Kt(),!0}catch{return t.clearToken(),q=null,Kt(),!1}}async function Zt(){if(q)return!0;return!!await Xt()||(function(e="login"){me&&(Yt(e),Rt(""),Wt(""),me.classList.remove("hidden"),document.body.style.overflow="hidden","register"===C&&Ee?Ee.focus():"reset"===C&&Pe?Pe.focus():pe&&pe.focus())}("login"),!1)}async function en(e){if(!e)return;if(!e.type.startsWith("image/"))return void Qt("Please choose an image file.",!0);if(e.size>15728640)return void Qt("Image is too large. Use a file under 15MB.",!0);const t=await(n=e,new Promise((e,t)=>{const i=new FileReader;i.onload=()=>e(String(i.result||"")),i.onerror=t,i.readAsDataURL(n)}));var n;let i=t;if(!/^data:image\/gif;base64,/i.test(t))try{const e=await(e=>new Promise((t,n)=>{const i=new Image;i.onload=()=>t(i),i.onerror=n,i.src=e}))(t),n=document.createElement("canvas");let r=Number(e.naturalWidth||e.width||0),s=Number(e.naturalHeight||e.height||0);if(r>0&&s>0){const t=720,o=Math.min(1,t/Math.max(r,s));r=Math.max(1,Math.round(r*o)),s=Math.max(1,Math.round(s*o)),n.width=r,n.height=s;const a=n.getContext("2d");if(a){const t=24e5;let o=.9,c=0,d=r,l=s;do{n.width=d,n.height=l,a.clearRect(0,0,d,l),a.drawImage(e,0,0,d,l);const r=n.toDataURL("image/webp",o),s=n.toDataURL("image/jpeg",o);if(i=r.length<=s.length?r:s,i.length<=t)break;o=Math.max(.55,o-.1),d=Math.max(220,Math.round(.88*d)),l=Math.max(220,Math.round(.88*l)),c+=1}while(c<6)}}}catch{i=t}i.length>29e5?Qt("This image format/size is still too large. Try JPG/PNG under ~5MB.",!0):(Ft=i,st&&(st.value=""),Jt(i),Ut(i),Qt("Profile picture ready. Click Save Profile to apply."))}function tn(){ue.disabled=!1,de.classList.remove("hidden"),document.body.style.overflow="hidden"}function nn(){de.classList.add("hidden"),document.body.style.overflow=""}ge&&ge.addEventListener("submit",async function(e){e.preventDefault();const n=String(pe?.value||"").trim(),i=String(Ee?.value||"").trim(),r=String(be?.value||"").trim(),s=String(Le?.value||"").trim(),o=String(Be?.value||"").trim().toLowerCase(),a=String(ke?.value||"").trim(),c=jt("auth-role","student"),d=String(Ce?.value||"").trim(),l=String(ze?.value||"").trim(),u=String(Me?.value||"").trim(),m=String(Pe?.value||"").trim(),g=String(De?.value||"");if("login"===C){if(!n)return void Rt("Username/contact/email is required.");if(!g||g.length<6)return void Rt("Password must be at least 6 characters.")}if("register"===C){if(!i||!r||!s)return void Rt("Title, first name and surname are required.");if(!o||o.length<3)return void Rt("Username must be at least 3 characters.");if(!a)return void Rt("Contact is required.");if(!d||!l||!u)return void Rt("Professional type, country and institution are required.");if(!g||g.length<6)return void Rt("Password must be at least 6 characters.")}if("forgot"!==C||n){if("reset"===C){if(!n||!m)return void Rt("Identifier and reset code are required.");if(!g||g.length<6)return void Rt("New password must be at least 6 characters.")}Ue&&(Ue.disabled=!0),Qe&&(Qe.disabled=!0),ye&&(ye.disabled=!0),fe&&(fe.disabled=!0),Rt("");try{if("login"===C){const e=await t.login({identifier:n,password:g});return q=e?.user||await t.fetchMe(),Kt(),_t(),void $n("quiz-menu")}if("register"===C){const e=await t.register({title:i,firstName:r,lastName:s,username:o,contact:a,role:c,professionalType:d,country:l,institution:u,password:g});return q=e?.user||await t.fetchMe(),Kt(),_t(),void $n("quiz-menu")}if("forgot"===C){const e=await t.forgotPassword({identifier:n}),i=String(e?.code||"").trim();return Yt("reset"),Wt(i?`Reset code: ${i}. Use it now to set a new password.`:String(e?.message||"Reset code sent.")),void(Pe&&i&&(Pe.value=i))}if("reset"===C)return await t.resetPassword({identifier:n,code:m,newPassword:g}),Yt("login"),Wt("Password reset complete. Sign in with your new password."),void(De&&(De.value=""))}catch(e){Wt(""),Rt(Vt(e))}finally{Ue&&(Ue.disabled=!1),Qe&&(Qe.disabled=!1),ye&&(ye.disabled=!1),fe&&(fe.disabled=!1)}}else Rt("Enter your username/contact/email first.")}),Oe&&(Oe.onclick=function(){De&&At("password"===De.type)}),ye&&(ye.onclick=()=>Yt("login")),fe&&(fe.onclick=()=>Yt("register")),Re&&(Re.onclick=()=>Yt("forgot")),We&&(We.onclick=()=>Yt("reset")),je&&(je.onclick=()=>Yt("login")),Qe&&(Qe.onclick=()=>{_t(),$n("home-screen")}),_e&&(_e.onclick=()=>{t.clearToken(),Ft="",q=null,Kt(),_t(),$n("home-screen")}),Ke&&(Ke.onclick=()=>{!async function(){await Zt()&&q&&(Qt(""),Gt(),$n("profile-screen"))}()}),Ve&&(Ve.onclick=()=>$n("quiz-menu")),Xe&&(Xe.onclick=async function(){if(!q)return;const e=String(q.profileImage||"").trim(),n=String(st?.value||"").trim()||Ft||e,i={title:String(ot?.value||"").trim()||String(q.title||"").trim()||"Mr",firstName:String(at?.value||"").trim()||String(q.firstName||"").trim(),lastName:String(ct?.value||"").trim()||String(q.lastName||"").trim(),username:String(dt?.value||"").trim().toLowerCase()||String(q.username||"").trim().toLowerCase(),contact:String(lt?.value||"").trim()||String(q.contact||q.email||"").trim(),role:jt("profile-role",String(q.role||"student").trim().toLowerCase()),professionalType:String(ut?.value||"").trim()||String(q.professionalType||"Other").trim(),country:String(mt?.value||"").trim()||String(q.country||"").trim()||"Not Set",institution:String(gt?.value||"").trim()||String(q.institution||"").trim()||"Not Set",profileImage:n};if(i.firstName&&i.lastName&&i.username&&i.contact)try{const e=await t.updateProfile(i);q=e?.user||await t.fetchMe(),Ft=String(q.profileImage||"").trim(),st&&(st.value=Ft),Kt(),Qt("Profile updated successfully.")}catch(e){Qt(Vt(e),!0)}else Qt("First name, surname, username and contact are required.",!0)}),Ze&&(Ze.onclick=async function(){const e=String(yt?.value||""),n=String(ft?.value||"");if(e&&n)if(n.length<6)Qt("New password must be at least 6 characters.",!0);else try{await t.changePassword({currentPassword:e,newPassword:n}),yt&&(yt.value=""),ft&&(ft.value=""),Qt("Password changed successfully.")}catch(e){Qt(Vt(e),!0)}else Qt("Enter current and new password.",!0)}),et&&(et.onclick=async function(){const e=Number(ht?.value||30);if(!Number.isInteger(e)||e<1||e>30)Qt("Deactivate days must be between 1 and 30.",!0);else if(confirm(`Deactivate this account for ${e} day(s)? It will be auto-deleted after that window.`))try{await t.deactivateAccount(e),t.clearToken(),Ft="",q=null,Kt(),$n("home-screen"),alert("Account deactivated. It will be deleted automatically after the selected period.")}catch(e){Qt(Vt(e),!0)}}),tt&&(tt.onclick=async function(){if(confirm("Delete account permanently? This cannot be undone.")&&confirm("Final warning: this will delete your account and history forever."))try{await t.deleteAccount(),t.clearToken(),Ft="",q=null,Kt(),$n("home-screen"),alert("Account deleted.")}catch(e){Qt(Vt(e),!0)}}),st&&st.addEventListener("input",()=>{const e=String(st.value||"").trim();Ft=e,Jt(e),Ut(e)}),rt&&rt.addEventListener("change",()=>{const e=rt.files?.[0];en(e).catch(()=>{Qt("Failed to read selected image.",!0)})}),ee&&ee.addEventListener("click",e=>{const t=String(ee.getAttribute("href")||"").trim();if(!t||"#"===t)return;e.preventDefault();const n=Array.isArray(l)?l[a]:null;Ot(t,n?.topicSlug?Mt(n.topicSlug):"Study Note","quiz-area")}),le.onclick=nn,ue.onclick=function(){ue.disabled=!0,nn(),xn()};const rn=document.getElementById("study-exit-modal"),sn=document.getElementById("cancel-study-exit-btn"),on=document.getElementById("confirm-study-exit-btn");function an(){rn.classList.add("hidden"),document.body.style.overflow=""}document.getElementById("end-study-btn").onclick=function(){on.disabled=!1,rn.classList.remove("hidden"),document.body.style.overflow="hidden"},sn.onclick=an,on.onclick=function(){on.disabled=!0,an(),function(){E=!0;const e=Object.keys(m).length,t=En(),n=0===e?0:Math.round(t/e*100);window.lastStudyResult={correct:t,total:e,percent:n},un("Study",t,e);const i=document.getElementById("study-result");i&&i.remove();document.getElementById("study-result-screen");const r=document.getElementById("result-title"),s=document.getElementById("result-percentage"),o=document.getElementById("result-score"),a=document.getElementById("result-feedback");r.innerText="Study Session Complete",s.innerText=n+"%",o.innerText=t+" / "+e+" Correct",n>=80?(a.innerText="Strong mastery demonstrated.",s.style.color="#15803d"):n>=60?(a.innerText="Progressing well. Keep refining.",s.style.color="#f9a825"):(a.innerText="More reinforcement needed.",s.style.color="#dc2626");$n("study-result-screen"),document.getElementById("result-review-btn").onclick=zn,document.getElementById("result-menu-btn").onclick=Bn,localStorage.removeItem("studySession"),localStorage.removeItem("practiceSession")}()},oe.onclick=function(){if("study"===d)return An(),void $n("study-setup");"exam"!==d&&"smart"!==d||tn()},ae&&(ae.onclick=function(){if("study"===d)return An(),void $n("quiz-menu");"exam"!==d&&"smart"!==d||tn()}),se&&(se.onclick=()=>{_t(),$n("home-screen")}),document.getElementById("study-back-btn").onclick=()=>{$n("quiz-menu")},document.getElementById("exam-back-btn").onclick=()=>{$n("quiz-menu")};const cn=document.getElementById("enter-platform-btn");cn&&(cn.onclick=async function(){await Zt()&&$n("quiz-menu")}),document.getElementById("start-exam-btn").onclick=async function(){const e=document.getElementById("exam-count-select").value;e?await function(e){let n;if(d="exam",clearInterval(s),s=null,a=0,c=0,m={},f=!1,e="all"===e?B.length:parseInt(e),"smart"===d)n=function(e){const t=function(e=80){return Object.keys(R).filter(t=>W(t)<e)}(),n=[];B.forEach(e=>{let i=1;t.includes(e.category)&&(i=3),n.push({question:e,weight:i})});const i=[];for(;i.length<e&&n.length>0;){const e=n.reduce((e,t)=>e+t.weight,0);let t=Math.random()*e;for(let e=0;e<n.length;e++)if(t-=n[e].weight,t<=0){i.push(n[e].question),n.splice(e,1);break}}return i}(e);else{const e=document.getElementById("category-select").value;if(e){if(n=B.filter(t=>t.category===e),0===n.length)return void alert("No questions available in this category yet.");n=Pn([...n])}else n=Pn([...B])}l=n.slice(0,e),"smart"===d&&l.forEach(e=>e.smartFlag=!0);k&&t.startAttempt({mode:"exam",category:document.getElementById("category-select")?.value||"all",questionIds:l.map(e=>Number(e.id))}).then(e=>{T=e.attemptId,console.info("Backend attempt started:",T)}).catch(e=>{console.warn("Failed to start backend attempt:",e)});u=40*l.length,yn(),$n("quiz-area"),bn(),hn()}(e):function(){const e=document.getElementById("exam-count-select"),t=document.createElement("div");t.innerText="Please select question count",t.style.position="absolute",t.style.background="#d32f2f",t.style.color="white",t.style.padding="6px 12px",t.style.borderRadius="6px",t.style.fontSize="12px",t.style.marginTop="5px",e.parentElement.appendChild(t),setTimeout(()=>{t.remove()},2e3)}()},re.onclick=function(){f=!1,$n("review-screen"),Sn(),re.classList.add("hidden")},j&&(j.onclick=()=>{document.getElementById("start-study-btn").onclick=fn,function(){const e=document.getElementById("study-best-streak"),t=document.getElementById("study-badge-number"),n=parseInt(localStorage.getItem("quizBestStreak"))||0;t.innerText=n,e.classList.remove("tier-basic","tier-blue","tier-green","tier-gold","tier-fire","tier-legend"),n<5?e.classList.add("tier-basic"):n<10?e.classList.add("tier-blue"):n<25?e.classList.add("tier-green"):n<50?e.classList.add("tier-gold"):n<100?e.classList.add("tier-fire"):e.classList.add("tier-legend")}(),mn("Study","study-history"),$n("study-setup"),Y.onclick=vn,_.onclick=In}),F&&(F.onclick=()=>{$n("exam-setup")});document.getElementById("dashboard");function dn({totalAttempts:e=0,overallAccuracy:t=0,weakCount:n=0,categories:i=[]}){document.getElementById("dash-total").innerText=e,document.getElementById("dash-accuracy").innerText=t+"%",document.getElementById("dash-weak").innerText=n;const r=document.getElementById("dash-categories");r.innerHTML="",Array.isArray(i)&&0!==i.length?i.forEach(e=>{const t=e.category||"General",n=Number(e.attempts)||0,i=Number(e.accuracy)||0,s=document.createElement("div");s.className="category-row",s.innerHTML=`\n      <div class="category-info">\n        <div class="category-name">${t}</div>\n        <div class="category-meta">${n} attempts</div>\n      </div>\n      <div class="category-bar">\n        <div class="category-fill" style="width:${i}%"></div>\n      </div>\n      <div class="category-percent">${i}%</div>\n    `,r.appendChild(s)}):r.innerHTML='<div class="no-data">No category data yet.</div>'}function ln(){$n("quiz-menu")}function un(e,n,i,r=null){const s={mode:e,score:n,total:i,percent:Math.round(n/i*100),date:(new Date).toLocaleString(),duration:r};x.unshift(s),x.length>20&&x.pop(),localStorage.setItem("quizSessionHistory",JSON.stringify(x)),t.syncSession(s),mn("Study","study-history"),mn("Exam","exam-history")}function mn(e,n){const i=document.getElementById(n);if(!i)return;const r=e=>{i.innerHTML="",0!==e.length?e.forEach(e=>{const t=document.createElement("div");t.innerHTML=`\n    <div style="\n      display:flex;\n      justify-content:space-between;\n      align-items:center;\n      padding:14px 0;\n      border-bottom:1px solid #eef2f7;\n    ">\n      <div>\n        <div style="\n          font-size:16px;\n          font-weight:700;\n          color:#1e3c72;\n        ">\n          ${e.score}/${e.total}\n        </div>\n\n        <div style="\n          font-size:11px;\n          opacity:0.6;\n          margin-top:4px;\n        ">\n          ${e.date}\n        </div>\n      </div>\n\n      <div style="\n        padding:6px 16px;\n        border-radius:20px;\n        font-size:12px;\n        font-weight:600;\n        background:${e.percent>=80?"#e6f4ea":"#fdecea"};\n        color:${e.percent>=80?"#2e7d32":"#c62828"};\n      ">\n        ${e.percent}%\n      </div>\n    </div>\n  `,i.appendChild(t)}):i.innerHTML='\n        <div style="font-size:13px; font-weight:700; margin-bottom:14px;">\n          No attempts yet.\n        </div>\n      '},s=x.filter(t=>t.mode.startsWith(e));r(s),t.fetchSyncedHistory(e).then(t=>{if(!Array.isArray(t?.sessions)||0===t.sessions.length)return;const n=t.sessions.map(t=>({mode:t.mode||e,score:Number(t.score)||0,total:Number(t.total)||0,percent:Number(t.percent)||0,date:t.date||"",duration:t.duration||null}));r(n)}).catch(()=>{})}function gn(e){if("study"!==d)return;const t=document.getElementById("streak-box"),n=document.getElementById("streak-value");e?(v++,v>L&&(L=v,localStorage.setItem("quizBestStreak",L)),t.classList.add("streak-animate"),setTimeout(()=>{t.classList.remove("streak-animate")},400)):v=0,n.innerText=v,t.classList.remove("tier-basic","tier-blue","tier-green","tier-gold","tier-fire","tier-legend"),v<5?t.classList.add("tier-basic"):v<10?t.classList.add("tier-blue"):v<25?t.classList.add("tier-green"):v<50?t.classList.add("tier-gold"):v<100?t.classList.add("tier-fire"):t.classList.add("tier-legend")}function yn(e=null){const t=document.getElementById("mode-indicator"),n=document.getElementById("header-stats"),i=document.getElementById("timer");t&&(te&&te.classList.remove("mode-study","mode-exam","mode-smart"),"study"===d?(t.innerText="weak"===e?"üìö Practice Weak Areas":"üìö Study Mode",n&&(n.style.display="flex"),i&&i.classList.add("hidden"),te&&te.classList.add("mode-study")):"exam"===d?(t.innerText="üìù Exam Mode",n&&(n.style.display="none"),i&&i.classList.remove("hidden"),te&&te.classList.add("mode-exam")):"smart"===d&&(t.innerText="Smart Exam",n&&(n.style.display="none"),i&&i.classList.remove("hidden"),te&&te.classList.add("mode-smart")))}function fn(){E=!1,clearInterval(s),s=null,V.classList.add("hidden"),V.innerText="";const e=document.getElementById("study-type-select").value,n=document.getElementById("study-category-select").value,i="weak"===e?"practiceSession":"studySession",r=localStorage.getItem(i);if(r){const e=JSON.parse(r);if(confirm("Resume previous session?")){d="study";document.getElementById("study-type-select").value;return g="",l=e.active,a=e.current,m=e.userAnswers,v=e.currentStreak||0,yn(e.studyType),$n("quiz-area"),hn(),void function(){const e=document.getElementById("streak-box"),t=document.getElementById("streak-value");if(!e||!t)return;t.innerText=v,e.classList.remove("tier-basic","tier-blue","tier-green","tier-gold","tier-fire","tier-legend"),v<5?e.classList.add("tier-basic"):v<10?e.classList.add("tier-blue"):v<25?e.classList.add("tier-green"):v<50?e.classList.add("tier-gold"):v<100?e.classList.add("tier-fire"):e.classList.add("tier-legend")}()}localStorage.removeItem(i)}if(d="study",clearInterval(s),s=null,a=0,c=0,m={},v=0,"normal"===e){if(yn("normal"),"all"===n)l=JSON.parse(JSON.stringify(B));else if(l=B.filter(e=>e.category===n),0===l.length)return void alert("No questions available in this category yet.");k&&t.startAttempt({mode:"study",category:n,questionIds:l.map(e=>Number(e.id))}).then(e=>{T=e.attemptId,console.info("Backend study attempt started:",T)}).catch(e=>{console.warn("Failed to start backend attempt:",e)});const e=document.getElementById("study-start-number").value;if(e&&"all"===n){const t=parseInt(e)-1;t>=0&&t<l.length&&(a=t)}const i=document.getElementById("mastery-progress");i&&i.classList.add("hidden")}if("weak"===e){yn("weak");const e=Object.keys(b);if(0===e.length)return void alert("No weak questions available yet.");l=e.map(e=>P(e)).filter(Boolean),a=0}$n("quiz-area"),hn()}function hn(){_.classList.remove("hidden"),Y.classList.remove("hidden"),f||re.classList.add("hidden"),K.innerHTML="",document.getElementById("combo-block").innerHTML="",X&&(X.classList.add("hidden"),X.innerText=""),Z&&Z.classList.add("hidden"),K.innerHTML="";const e=l[a];if(h=!1,"study"===d){ne.innerText=`Question ${a+1} of ${l.length}`;const e=Object.keys(m).length,t=En();ie.innerText=`${t}/${e}`}else ne.innerText="",ie.innerText="";const t=document.getElementById("end-study-btn");if("study"!==d||p?t.classList.add("hidden"):t.classList.remove("hidden"),"study"===d){const t=O(e.id),n=W(e.category);ne.innerText+=` | Q Accuracy: ${t}% | Category: ${e.category} (${n}%)`}let n=e.question;if("exam"===d||"smart"===d){n=`Question ${a+1}<br><br>`+e.question.replace(/^Q\d+\.\s*/,"")}let i="";e.caseId&&S[e.caseId]&&(i=S[e.caseId]),G.innerHTML=i?`<strong>Case:</strong><br>${i}<br><br>`+n:n;const r=Array.isArray(e.options)?e.options:[],s=Array.isArray(e.statements)?e.statements:[];if("match"!==e.type&&"single"!==e.type||r.forEach(t=>{const n=document.createElement("button");n.innerText=t,n.dataset.value=t,n.onclick=()=>pn(t,e),K.appendChild(n)}),"combo"===e.type){s.forEach((e,t)=>{const n=document.createElement("p");/^\d+\./.test(e.trim())?n.innerText=e:n.innerText=`${t+1}. ${e}`,ce.appendChild(n)});[{letter:"A",text:"A: 1, 2 and 3"},{letter:"B",text:"B: 1 and 2 only"},{letter:"C",text:"C: 2 and 3 only"},{letter:"D",text:"D: 1 only"},{letter:"E",text:"E: 3 only"}].forEach(t=>{const n=document.createElement("button");n.innerText=t.text,n.dataset.value=t.letter,n.onclick=()=>pn(t.letter,e),K.appendChild(n)})}if(0===K.children.length){const e=document.createElement("div");e.className="no-options-fallback",e.innerText="This question has no answer options configured yet.",K.appendChild(e)}!function(e){const t=m[e.id];if(!t)return;document.querySelectorAll("#answers button").forEach(n=>{const i=n.dataset.value;n.innerText.startsWith("A")||n.innerText.startsWith("B")||n.innerText.startsWith("C")||n.innerText.startsWith("D")||n.innerText.startsWith("E")?n.innerText[0]:n.innerText,"study"===d&&(n.disabled=!0,i===e.correct&&n.classList.add("correct"),i===t&&t!==e.correct&&n.classList.add("wrong")),"exam"===d&&i===t&&(n.style.background="#dbe7ff")}),"study"===d&&(X&&(X.innerText=e.explanation,X.classList.remove("hidden")),Nt(e));"study"===d&&Y.classList.remove("hidden")}(e)}function pn(e,n){if(I)return;if(m[n.id]=e,k&&T&&t.answerAttempt(T,n.id,e),"study"===d){D(n.id,e===n.correct);const t=document.getElementById("study-type-select").value;"study"===d&&"normal"===t&&e!==n.correct&&(b[n.id]||(b[n.id]={roundsPassed:0},w()))}const i=document.getElementById("study-type-select").value;if("study"===d&&"weak"===i){e===n.correct?(b[n.id].roundsPassed++,b[n.id].roundsPassed>=2&&delete b[n.id]):b[n.id].roundsPassed=0,w()}if("study"===d){document.getElementById("study-type-select").value}if(gn(e===n.correct),E||An(),("exam"===d||"smart"===d)&&!f)return Cn(),void(a<l.length-1?(a++,hn()):Ln());document.querySelectorAll("#answers button").forEach(t=>{t.disabled=!0;const i=t.dataset.value;t.innerText.startsWith("A")||t.innerText.startsWith("B")||t.innerText.startsWith("C")||t.innerText.startsWith("D")||t.innerText.startsWith("E")?t.innerText[0]:t.innerText,i===n.correct&&t.classList.add("correct"),i===e&&e!==n.correct&&t.classList.add("wrong")});const r=Object.keys(m).length,s=En();ie.innerText=`${s}/${r}`,X&&(X.innerText=n.explanation,X.classList.remove("hidden")),Nt(n),h=!0,Y.innerText=a===l.length-1?"Finish":"Next"}function vn(){if(!p){if("exam"===d||"smart"===d)return Y.innerText="Skip",Cn(),void(a<l.length-1?(a++,hn()):Ln());if("study"===d){const e=l[a];if(!h&&!m[e.id]){m[e.id]="Skipped",D(e.id,!1),gn(!1);return document.querySelectorAll("#answers button").forEach(t=>{t.disabled=!0;const n=t.dataset.value;t.innerText.startsWith("A")||t.innerText.startsWith("B")||t.innerText.startsWith("C")||t.innerText.startsWith("D")||t.innerText.startsWith("E")?t.innerText[0]:t.innerText,n===e.correct&&t.classList.add("correct")}),X&&(X.innerText=e.explanation,X.classList.remove("hidden")),Nt(e),h=!0,void(Y.innerText=a===l.length-1?"Finish":"Next")}a<l.length-1?(a++,hn()):function(){re.classList.add("hidden");document.getElementById("study-type-select").value;E=!0;const e=Object.keys(m).length,n=En(),i=0===e?0:Math.round(n/e*100);if(k&&T){const e={};Object.keys(m).forEach(t=>{e[t]=m[t]}),t.finishAttempt(T,e),T=null}localStorage.removeItem("studySession"),localStorage.removeItem("practiceSession");document.getElementById("study-result-screen");const r=document.getElementById("result-title"),s=document.getElementById("result-percentage"),o=document.getElementById("result-score"),a=document.getElementById("result-feedback");r.innerText="Study Session Complete",s.innerText=i+"%",o.innerText=n+" / "+e+" Correct",i>=80?(a.innerText="Strong mastery demonstrated.",s.style.color="#15803d"):i>=60?(a.innerText="Progressing well. Keep refining.",s.style.color="#f9a825"):(a.innerText="More reinforcement needed.",s.style.color="#dc2626");$n("study-result-screen"),document.getElementById("result-review-btn").onclick=zn,document.getElementById("result-menu-btn").onclick=Bn}()}An()}}function En(){let e=0;return Object.keys(m).forEach(t=>{const n=l.find(e=>e.id==t);n&&m[t]===n.correct&&e++}),e}function In(){a>0&&(a--,hn()),An()}function bn(){s&&clearInterval(s),V.classList.remove("hidden"),wn(),s=setInterval(()=>{u>0?(u--,wn()):(clearInterval(s),Ln())},1e3)}function wn(){const e=Math.floor(u/60),t=u%60,n=String(e).padStart(2,"0")+":"+String(t).padStart(2,"0");V.innerHTML=`<span class="timer-icon">‚è±</span> ${n}`,function(){const e=u/(40*l.length);V.classList.remove("timer-safe","timer-warning","timer-danger"),e>.5?V.classList.add("timer-safe"):e>.2?V.classList.add("timer-warning"):V.classList.add("timer-danger")}()}function Ln(){clearInterval(s),s=null,f=!0,y=l.length,$n("review-screen"),Sn();const e=document.getElementById("submit-exam");e.classList.remove("hidden"),e.onclick=xn,function(){const e=document.getElementById("review-timer");e.innerText=`Review Time Left: ${y}s`,o=setInterval(()=>{y--,e.innerText=`Review Time Left: ${y}s`,y<=0&&(clearInterval(o),xn())},1e3)}()}function xn(){clearInterval(s),s=null,clearInterval(o),f=!1,re.classList.add("hidden");const e=d;d="",localStorage.removeItem("quizExamSession"),localStorage.removeItem("examAbandoned");let n=0;const i={};if(l.forEach(e=>{const t=m[e.id]===e.correct;t&&n++,i[e.id]=m[e.id],D(e.id,t)}),k&&T){const e=Math.max(0,40*l.length-(u||0));t.finishAttempt(T,i,e),T=null}let r=Math.round(n/l.length*100);un("smart"===e?"Smart ("+l.length+")":"Exam ("+l.length+")",n,l.length,"Time Used: "+(40*l.length-u)+"s");document.getElementById("study-result-screen");const a=document.getElementById("result-title"),c=document.getElementById("result-percentage"),g=document.getElementById("result-score"),y=document.getElementById("result-feedback");a.innerText="Exam Complete",c.innerText=r+"%",g.innerText=n+" / "+l.length+" Correct",r>=80?(y.innerText="Excellent performance. You're exam ready.",c.style.color="#15803d"):r>=60?(y.innerText="Good effort. Review weak areas.",c.style.color="#f9a825"):(y.innerText="Needs improvement. Focus and repeat.",c.style.color="#dc2626"),$n("study-result-screen"),document.getElementById("result-review-btn").onclick=kn,document.getElementById("result-menu-btn").onclick=Bn}function Bn(){const e=document.getElementById("detailed-review");e&&e.remove(),p=!1,h=!1,Y.onclick=vn,_.onclick=In,document.getElementById("back-btn-quiz").classList.remove("hidden"),ae&&ae.classList.remove("hidden"),Y.onclick=vn,_.onclick=In,$n("quiz-menu")}function Sn(){const e=document.getElementById("review-list");e.innerHTML="",l.forEach((t,n)=>{const i=document.createElement("button");i.innerText=n+1,i.classList.add("review-btn"),m[t.id]?i.classList.add("review-answered"):i.classList.add("review-unanswered"),i.onclick=()=>function(e){f=!0,re.classList.remove("hidden"),$n("quiz-area"),a=e,hn()}(n),e.appendChild(i)})}function kn(){const e=document.getElementById("result-review-section"),t=document.getElementById("result-review-content");I=!1,e.classList.remove("hidden"),t.classList.remove("review-palette-grid"),t.classList.add("analysis-list"),t.innerHTML="",l.forEach((e,n)=>{const i=m[e.id]||"Not Answered",r=i===e.correct,s=document.createElement("div");s.className="analysis-card "+(r?"analysis-correct":"analysis-wrong"),s.classList.add("analysis-clickable"),s.onclick=()=>function(e){I=!0,a=e,$n("quiz-area"),re.classList.remove("hidden"),re.onclick=Tn,document.getElementById("back-btn-quiz").classList.add("hidden"),qn(),Y.classList.remove("hidden"),_.classList.remove("hidden"),Y.onclick=()=>{a<l.length-1&&(a++,qn())},_.onclick=()=>{a>0&&(a--,qn())}}(n),s.innerHTML=`\n      <div class="analysis-header">\n        <div>Question ${n+1}</div>\n        <div>${r?"‚úì Correct":"‚úï Incorrect"}</div>\n      </div>\n      <div class="analysis-question">\n        ${e.question.replace(/^Q\\d+\\.\\s*/,"")}\n      </div>\n      <div class="analysis-answer">\n        <strong>Your Answer:</strong> ${i}\n      </div>\n      ${r?"":`<div><strong>Correct:</strong> ${e.correct}</div>`}\n    `,t.appendChild(s)}),document.getElementById("result-back-btn").onclick=function(){document.getElementById("result-review-section").classList.add("hidden"),t.classList.remove("analysis-list"),document.getElementById("result-review-content").innerHTML="",document.querySelector(".result-body").scrollTop=0}}function Tn(){I=!1,re.classList.add("hidden"),document.getElementById("back-btn-quiz").classList.remove("hidden"),Y.onclick=vn,_.onclick=In,$n("study-result-screen"),kn()}function qn(){const e=l[a];K.innerHTML="";let t="";e.caseId&&S[e.caseId]&&(t="<strong>Case:</strong><br>"+S[e.caseId]+"<br><br>"),G.innerHTML=t+`<strong>Question ${a+1}</strong><br><br>`+e.question.replace(/^Q\d+\.\s*/,"");const n=m[e.id];if("match"===e.type||"single"===e.type)e.options.forEach(t=>{const i=document.createElement("button");i.innerText=t,i.disabled=!0,t===e.correct&&i.classList.add("correct"),n===t&&t!==e.correct&&i.classList.add("wrong"),K.appendChild(i)});else if("combo"===e.type){ce.innerHTML="",K.innerHTML="",e.statements.forEach((e,t)=>{const n=document.createElement("p");/^\d+\./.test(e.trim())?n.innerText=e:n.innerText=`${t+1}. ${e}`,ce.appendChild(n)});[{letter:"A",text:"A: 1, 2 and 3"},{letter:"B",text:"B: 1 and 2 only"},{letter:"C",text:"C: 2 and 3 only"},{letter:"D",text:"D: 1 only"},{letter:"E",text:"E: 3 only"}].forEach(t=>{const i=document.createElement("button");i.innerText=t.text,i.disabled=!0,t.letter===e.correct&&i.classList.add("correct"),n===t.letter&&t.letter!==e.correct&&i.classList.add("wrong"),K.appendChild(i)})}else e.options&&e.options.forEach(t=>{const i=document.createElement("button");i.innerText=t,i.disabled=!0,t===e.correct&&i.classList.add("correct"),n===t&&t!==e.correct&&i.classList.add("wrong"),K.appendChild(i)});X&&(X.innerText=e.explanation||"No explanation provided.",X.classList.remove("hidden")),Nt(e)}function Cn(){const e={active:l,current:a,userAnswers:m,examTimeLeft:u,timestamp:Date.now()};localStorage.setItem("quizExamSession",JSON.stringify(e))}function An(){if("study"!==d||E)return;const e={current:a,userAnswers:m,active:l,currentStreak:v,studyType:document.getElementById("study-type-select").value},t="weak"===e.studyType?"practiceSession":"studySession";localStorage.setItem(t,JSON.stringify(e))}function zn(){const e=document.getElementById("result-review-section"),t=document.getElementById("result-review-content");e.classList.remove("hidden"),t.classList.remove("analysis-list"),t.classList.add("review-palette-grid"),t.innerHTML="",l.forEach((e,n)=>{if(!m[e.id])return;const i=document.createElement("button");i.className="review-btn",i.innerText=n+1,m[e.id]===e.correct?i.classList.add("review-correct"):"Skipped"===m[e.id]?i.classList.add("review-skipped"):i.classList.add("review-wrong"),i.onclick=()=>function(e){a=e,p=!0;const t=document.getElementById("study-review");t&&t.remove();$n("quiz-area"),re.classList.remove("hidden"),re.onclick=Nn,Y.onclick=()=>{const e=l.map((e,t)=>m[e.id]?t:null).filter(e=>null!==e),t=e.indexOf(a);t<e.length-1&&(a=e[t+1],Mn())},_.onclick=()=>{const e=l.map((e,t)=>m[e.id]?t:null).filter(e=>null!==e),t=e.indexOf(a);t>0&&(a=e[t-1],Mn())},Mn()}(n),t.appendChild(i)}),document.getElementById("result-back-btn").onclick=function(){document.getElementById("result-review-section").classList.add("hidden"),t.classList.remove("review-palette-grid"),document.getElementById("result-review-content").innerHTML="",document.querySelector(".result-body").scrollTop=0}}function Nn(){p=!1,re.classList.add("hidden"),document.getElementById("back-btn-quiz").classList.remove("hidden"),ae&&ae.classList.remove("hidden"),Y.onclick=vn,_.onclick=In,$n("study-result-screen"),zn()}function Mn(){document.getElementById("end-study-btn").classList.add("hidden"),document.getElementById("back-btn-quiz").classList.add("hidden"),ae&&ae.classList.add("hidden");const e=l[a];K.innerHTML="",G.innerHTML=e.question;const t=m[e.id];if("match"===e.type||"single"===e.type)e.options.forEach(n=>{const i=document.createElement("button");i.innerText=n,i.disabled=!0,n===e.correct&&i.classList.add("correct"),t===n&&n!==e.correct&&i.classList.add("wrong"),K.appendChild(i)});else if("combo"===e.type){ce.innerHTML="",K.innerHTML="",e.statements.forEach((e,t)=>{const n=document.createElement("p");n.innerText=/^\d+\./.test(e.trim())?e:`${t+1}. ${e}`,ce.appendChild(n)});[{letter:"A",text:"A: 1, 2 and 3"},{letter:"B",text:"B: 1 and 2 only"},{letter:"C",text:"C: 2 and 3 only"},{letter:"D",text:"D: 1 only"},{letter:"E",text:"E: 3 only"}].forEach(n=>{const i=document.createElement("button");i.innerText=n.text,i.dataset.value=n.letter,i.disabled=!0,n.letter===e.correct&&i.classList.add("correct"),t===n.letter&&n.letter!==e.correct&&i.classList.add("wrong"),K.appendChild(i)})}}function $n(e){["home-screen","quiz-menu","profile-screen","study-setup","exam-setup","topic-library","topic-viewer","quiz-area","review-screen","dashboard","study-result-screen"].forEach(e=>{const t=document.getElementById(e);t&&t.classList.remove("screen-active")});const t=document.getElementById(e);t&&t.classList.add("screen-active"),"quiz-area"!==e&&V&&V.classList.add("hidden"),history.state&&history.state.screen===e||history.pushState({screen:e},"","")}function Pn(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}J&&(J.onclick=function(){$n("dashboard");let e=0,n=0,i=0;B.forEach(t=>{const r=H[t.id];r&&(e+=r.attempts,n+=r.correct,O(t.id)<60&&i++)});const r=0===e?0:Math.round(n/e*100);dn({totalAttempts:e,overallAccuracy:r,weakCount:i,categories:Object.keys(R).map(e=>({category:e,attempts:R[e].attempts,accuracy:W(e)}))}),t.fetchSyncedDashboard().then(e=>{e&&"object"==typeof e&&dn({totalAttempts:Number(e.totalAttempts??e.totalQuestionAttempts)||0,overallAccuracy:Number(e.overallAccuracy)||0,weakCount:Number(e.weakQuestions)||0,categories:Array.isArray(e.categories)?e.categories:[]})}).catch(()=>{}),document.getElementById("dashboard-close-btn").onclick=ln}),window.addEventListener("load",function(){Yt("login"),Jt(""),Ut(""),Kt(),Xt(),async function(){try{const e=await t.fetchQuestions({limit:1e3});Array.isArray(e)&&e.length>0&&(B=e.map(e=>({id:e.id,text:e.text||e.question||"",question:e.question||e.text||"",category:r(e.category,`${String(e.question||e.text||"")} ${String(e.explanation||"")}`),options:e.options,correct:e.correct,explanation:e.explanation||"",type:e.type||"single",topicSlug:e.topicSlug||"",sectionId:e.sectionId||""})),k=!0,console.info(`Loaded ${B.length} questions from backend`))}catch(e){console.warn("Backend unavailable, using local questions:",e)}}().then(()=>{$()}),t.warmup().catch(()=>{}),function(){const e=document.getElementById("study-category-select");e&&(e.innerHTML='<option value="all">All Categories</option>',n.forEach(t=>{const n=document.createElement("option");n.value=t,n.innerText=`Study ‚Äì ${t}`,e.appendChild(n)}))}(),function(){const e=document.getElementById("category-select");e&&(e.innerHTML='<option value="">All Categories</option>',n.forEach(t=>{const n=document.createElement("option");n.value=t,n.innerText=t,e.appendChild(n)}))}(),Et&&(Et.innerHTML='<option value="all">All Categories</option>',n.forEach(e=>{const t=document.createElement("option");t.value=e,t.innerText=e,Et.appendChild(t)})),mn("Study","study-history"),mn("Exam","exam-history");if(localStorage.getItem("examAbandoned")){localStorage.removeItem("examAbandoned");const e=JSON.parse(localStorage.getItem("quizExamSession"));if(e)return l=e.active,m=e.userAnswers||{},d="exam",void xn();const t=document.getElementById("home-total-questions"),n=document.getElementById("home-total-sessions"),i=document.getElementById("home-best-streak");t&&(t.innerText=B.length),n&&(n.innerText=x.length),i&&(i.innerText=localStorage.getItem("quizBestStreak")||0)}$n("home-screen")}),document.addEventListener("keydown",function(e){!me||me.classList.contains("hidden")||"Escape"!==e.key?(de.classList.contains("hidden")||"Escape"!==e.key||nn(),rn.classList.contains("hidden")||"Escape"!==e.key||an()):_t()}),window.addEventListener("beforeunload",function(){("exam"===d||"smart"===d)&&l.length>0&&(localStorage.setItem("examAbandoned","true"),Cn())}),window.addEventListener("popstate",function(){const e=document.querySelector(".screen-active"),t=e?e.id:null;if(me&&!me.classList.contains("hidden"))return void _t();const n=document.getElementById("study-exit-modal");if(n&&!n.classList.contains("hidden"))return n.classList.add("hidden"),void(document.body.style.overflow="");if(de.classList.contains("hidden")){if("quiz-area"===t){if("study"===d)return An(),void $n("study-setup");if("exam"===d||"smart"===d)return void tn()}"study-setup"!==t&&"exam-setup"!==t&&"profile-screen"!==t?"topic-viewer"!==t?"topic-library"!==t?"quiz-menu"!==t||$n("home-screen"):$n(N||"quiz-menu"):$n(M||"topic-library"):$n("quiz-menu")}else nn()});